<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin - Productos</title>
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/layout.css">
  <link rel="stylesheet" href="/assets/css/components.css">
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="icon" href="/assets/img/logo.svg">
  <script type="module">
    import { requireAuth } from '/assets/js/auth.js';
    import { renderHeader, showToast } from '/assets/js/ui.js';
    import { apiFetch } from '/assets/js/api.js';
    requireAuth(['admin', 'empleado']);
    
    let allProducts = [];
    let filtered = [];
    let page = 1;
    
    window.addEventListener('DOMContentLoaded', async ()=>{
      renderHeader({ active:'products' });
      setupFilters();
      await loadProducts();
    });
    
    function setupFilters() {
      const qInput = document.getElementById('q');
      const pageSizeSel = document.getElementById('pageSize');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const pageInfo = document.getElementById('pageInfo');
      
      function render(){
        const pageSize = Number(pageSizeSel.value);
        const start = (page-1)*pageSize;
        const rows = filtered.slice(start, start+pageSize);
        const tbody = document.querySelector('tbody');
        tbody.innerHTML = rows.map(p=>`<tr>
          <td>#${p.id}</td>
          <td>${escapeHtml(p.nombre)}</td>
          <td>$${Number(p.precio).toLocaleString()}</td>
          <td>${escapeHtml(p.categoria || '—')}</td>
          <td><span class="badge ${p.estado === 'garantia' ? 'badge--warning' : 'badge--success'}">${p.estado === 'garantia' ? 'Garantía' : 'Venta'}</span></td>
          <td>${escapeHtml(p.sucursal || '—')}</td>
          <td>${p.cantidad || 0}</td>
          <td><a class="button" href="admin_product_detail.html?id=${p.id}">Ver</a></td>
        </tr>`).join('');
        const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
        pageInfo.textContent = `${page} / ${totalPages}`;
        prevBtn.disabled = page<=1;
        nextBtn.disabled = page>=totalPages;
      }
      
      function applyFilter(){
        const q = (qInput.value||'').toLowerCase();
        filtered = allProducts.filter(p => 
          `${p.id} ${p.nombre} ${p.categoria || ''} ${p.sucursal || ''}`.toLowerCase().includes(q)
        );
        page = 1;
        render();
      }
      
      prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
      nextBtn.addEventListener('click', ()=>{ const totalPages=Math.ceil(filtered.length/Number(pageSizeSel.value))||1; if(page<totalPages){ page++; render(); }});
      pageSizeSel.addEventListener('change', ()=>{ page=1; render(); });
      qInput.addEventListener('input', ()=> applyFilter());
    }
    
    async function loadProducts() {
      try {
        const response = await apiFetch('productos','');
        allProducts = Array.isArray(response) ? response : (response?.data || []);
        filtered = allProducts.slice();
        const render = () => {
          const pageSize = Number(document.getElementById('pageSize').value);
          const start = (page-1)*pageSize;
          const rows = filtered.slice(start, start+pageSize);
          const tbody = document.querySelector('tbody');
          tbody.innerHTML = rows.map(p=>`<tr>
            <td>#${p.id}</td>
            <td>${escapeHtml(p.nombre || 'Sin nombre')}</td>
            <td>$${Number(p.precio || 0).toLocaleString()}</td>
            <td>${escapeHtml(p.categoria || '—')}</td>
            <td><span class="badge ${p.estado === 'garantia' ? 'badge--warning' : 'badge--success'}">${p.estado === 'garantia' ? 'Garantía' : 'Venta'}</span></td>
            <td>${escapeHtml(p.sucursal || '—')}</td>
            <td>${p.cantidad || 0}</td>
            <td><a class="button" href="admin_product_detail.html?id=${p.id}">Ver</a></td>
          </tr>`).join('');
          const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
          document.getElementById('pageInfo').textContent = `${page} / ${totalPages}`;
          document.getElementById('prev').disabled = page<=1;
          document.getElementById('next').disabled = page>=totalPages;
        };
        render();
      } catch(err) {
        console.error('Error cargando productos:', err);
        document.querySelector('tbody').innerHTML = '<tr><td colspan=8>No se pudieron cargar</td></tr>';
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
  </script>
</head>
<body>
  <header></header>
  <main class="container">
    <h1>Gestión de Productos</h1>
    <div class="card" style="margin-bottom:12px;display:flex;gap:12px;align-items:center">
      <input id="q" class="input" placeholder="Buscar por id, nombre, categoría o sucursal" style="flex:1">
      <label for="pageSize" style="color:var(--color-text-muted)">Por página</label>
      <select id="pageSize" class="input" style="width:120px">
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
      <button id="prev" class="button" type="button">Anterior</button>
      <span id="pageInfo" style="min-width:60px;text-align:center">1 / 1</span>
      <button id="next" class="button" type="button">Siguiente</button>
    </div>
    <table class="table">
      <thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Categoría</th><th>Estado</th><th>Sucursal</th><th>Stock</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </main>
</body>
</html>

