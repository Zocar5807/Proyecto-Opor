<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mis Contratos - La Oportunidad</title>
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/layout.css">
  <link rel="stylesheet" href="/assets/css/components.css">
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="icon" href="/assets/img/logo.svg">
  <style>
    .contract-card {
      margin-bottom: var(--spacing-lg);
    }
    .contract-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
      gap: var(--spacing-md);
    }
    .contract-card__info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }
    .contract-card__info-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    .contract-card__info-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .contract-card__info-value {
      font-size: var(--font-size-base);
      color: var(--color-text);
      font-weight: var(--font-weight-medium);
    }
    .contract-card__actions {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      margin-top: var(--spacing-md);
    }
    .alert-banner {
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      border: 2px solid #F59E0B;
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    .alert-banner__icon {
      font-size: var(--font-size-2xl);
    }
    .alert-banner__content {
      flex: 1;
    }
    .alert-banner__title {
      margin: 0 0 var(--spacing-xs);
      font-weight: var(--font-weight-semibold);
      color: #92400E;
    }
    .alert-banner__text {
      margin: 0;
      color: #78350F;
      font-size: var(--font-size-sm);
    }
    
    /* Modal de Pago */
    .payment-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: var(--z-modal);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-4);
    }
    
    .payment-modal__backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .payment-modal__content {
      position: relative;
      background: var(--color-bg-elevated);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-2xl);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: var(--z-modal);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .payment-modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-6);
      border-bottom: 2px solid var(--color-border-light);
      background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-primary-100) 100%);
    }
    
    .payment-modal__header h2 {
      color: var(--color-primary-800);
      font-size: var(--font-size-2xl);
    }
    
    .payment-modal__close {
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      cursor: pointer;
      padding: var(--spacing-2);
      border-radius: var(--radius-md);
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .payment-modal__close:hover {
      background: var(--color-bg-tertiary);
      color: var(--color-text-primary);
    }
    
    .payment-modal__body {
      padding: var(--spacing-6);
    }
    
    .payment-modal__saldo-info {
      background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-primary-100) 100%);
      border: 2px solid var(--color-primary-200);
      border-radius: var(--radius-xl);
      padding: var(--spacing-5);
      margin-bottom: var(--spacing-6);
      text-align: center;
    }
    
    .payment-modal__saldo-label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .payment-modal__saldo-amount {
      display: block;
      font-size: var(--font-size-4xl);
      font-weight: var(--font-weight-extrabold);
      color: var(--color-primary);
      text-shadow: 0 2px 4px rgba(22, 163, 74, 0.1);
    }
    
    .payment-modal__actions {
      display: flex;
      gap: var(--spacing-4);
      justify-content: flex-end;
      margin-top: var(--spacing-6);
      padding-top: var(--spacing-5);
      border-top: 2px solid var(--color-border-light);
    }
    
    .payment-modal__submit-btn {
      background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%);
      color: var(--color-text-on-primary);
      box-shadow: var(--shadow-md);
    }
    
    .payment-modal__submit-btn:hover {
      background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-800) 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .payment-modal__submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .form-group {
      margin-bottom: var(--spacing-5);
    }
    
    .form-group label {
      display: block;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-2);
      font-size: var(--font-size-sm);
    }
    
    .form-group .input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--spacing-3) var(--spacing-4);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-base);
      transition: all var(--transition-base);
      background: var(--color-bg-elevated);
      font-family: var(--font-family);
    }
    
    .form-group .input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }
    
    .form-group small {
      display: block;
      margin-top: var(--spacing-1);
      color: var(--color-text-muted);
      font-size: var(--font-size-xs);
    }
  </style>
  <script type="module">
    import { requireAuth, getUserId } from '/assets/js/auth.js';
    import { renderHeader, showToast } from '/assets/js/ui.js';
    import { apiFetch } from '/assets/js/api.js';
    requireAuth();
    
    let allContracts = [];
    let allPagos = {};
    
    window.addEventListener('DOMContentLoaded', async () => {
      renderHeader({ active: 'contracts' });
      await loadContracts();
    });
    
    async function loadContracts() {
      const container = document.getElementById('contractsContainer');
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      
      try {
        loadingState.style.display = 'block';
        container.style.display = 'none';
        emptyState.style.display = 'none';
        
        const response = await apiFetch('contratos', '?mine=true');
        allContracts = Array.isArray(response) ? response : (response?.data || []);
        
        // Cargar pagos y saldos para cada contrato
        for (const contract of allContracts) {
          try {
            const pagosData = await apiFetch('contratos', `/${contract.id}/pagos`);
            allPagos[contract.id] = pagosData?.saldo || { montoTotal: contract.monto || 0, totalPagado: 0, saldo: contract.monto || 0 };
          } catch (err) {
            console.warn(`No se pudieron cargar pagos para contrato ${contract.id}:`, err);
            allPagos[contract.id] = { montoTotal: contract.monto || 0, totalPagado: 0, saldo: contract.monto || 0 };
          }
        }
        
        if (allContracts.length === 0) {
          loadingState.style.display = 'none';
          emptyState.style.display = 'block';
          return;
        }
        
        renderContracts();
        checkVencimientos();
        
        container.style.display = 'block';
        emptyState.style.display = 'none';
      } catch (err) {
        console.error('Error cargando contratos:', err);
        container.innerHTML = `
          <div class="empty-state">
            <h3 class="empty-state-title">Error al cargar contratos</h3>
            <p class="empty-state-text">${err.message || 'Hubo un problema conectando con el servidor'}</p>
          </div>
        `;
        container.style.display = 'block';
      } finally {
        loadingState.style.display = 'none';
      }
    }
    
    function renderContracts() {
      const container = document.getElementById('contractsContainer');
      
      container.innerHTML = allContracts.map(contract => {
        const id = contract.id || contract.con_numero;
        const estado = contract.estado || contract.con_estado || 'A';
        const fecha = contract.fecha || contract.con_fecha;
        const fechaPlazo = contract.fechaPlazo || contract.con_fecha_plazo || contract.fecha_plazo;
        const monto = contract.monto || contract.con_valor || 0;
        const saldo = allPagos[id] || { montoTotal: monto, totalPagado: 0, saldo: monto };
        
        const estadoBadge = getEstadoBadge(estado);
        const isVencido = fechaPlazo && new Date(fechaPlazo) < new Date();
        const diasRestantes = fechaPlazo ? Math.ceil((new Date(fechaPlazo) - new Date()) / (1000 * 60 * 60 * 24)) : null;
        
        return `
          <article class="card contract-card">
            <div class="contract-card__header">
              <div>
                <h3 style="margin: 0 0 var(--spacing-xs);">Contrato #${id}</h3>
                <p style="margin: 0; color: var(--color-text-muted); font-size: var(--font-size-sm);">
                  ${formatDate(fecha)}
                </p>
              </div>
              ${estadoBadge}
            </div>
            
            ${isVencido && estado !== 'P' ? `
              <div class="alert-banner">
                <div class="alert-banner__icon">‚ö†Ô∏è</div>
                <div class="alert-banner__content">
                  <h4 class="alert-banner__title">Contrato vencido</h4>
                  <p class="alert-banner__text">La fecha l√≠mite de pago ha pasado. Contacta a la sucursal para evitar la p√©rdida del bien en garant√≠a.</p>
                </div>
              </div>
            ` : diasRestantes !== null && diasRestantes <= 7 && diasRestantes > 0 ? `
              <div class="alert-banner">
                <div class="alert-banner__icon">‚è∞</div>
                <div class="alert-banner__content">
                  <h4 class="alert-banner__title">Pr√≥ximo a vencer</h4>
                  <p class="alert-banner__text">Quedan ${diasRestantes} d√≠a${diasRestantes > 1 ? 's' : ''} para el vencimiento del contrato.</p>
                </div>
              </div>
            ` : ''}
            
            <div class="contract-card__info">
              <div class="contract-card__info-item">
                <span class="contract-card__info-label">Monto del pr√©stamo</span>
                <span class="contract-card__info-value" style="color: var(--color-primary); font-size: var(--font-size-xl); font-weight: var(--font-weight-bold);">
                  $${Number(monto).toLocaleString()}
                </span>
              </div>
              <div class="contract-card__info-item">
                <span class="contract-card__info-label">Total pagado</span>
                <span class="contract-card__info-value" style="color: var(--color-success);">
                  $${Number(saldo.totalPagado).toLocaleString()}
                </span>
              </div>
              <div class="contract-card__info-item">
                <span class="contract-card__info-label">Saldo pendiente</span>
                <span class="contract-card__info-value" style="color: ${saldo.saldo > 0 ? 'var(--color-error)' : 'var(--color-success)'}; font-weight: var(--font-weight-bold);">
                  $${Number(saldo.saldo).toLocaleString()}
                </span>
              </div>
              ${fechaPlazo ? `
                <div class="contract-card__info-item">
                  <span class="contract-card__info-label">Fecha l√≠mite</span>
                  <span class="contract-card__info-value" style="color: ${isVencido ? 'var(--color-error)' : 'var(--color-text)'};">
                    ${formatDate(fechaPlazo)}
                  </span>
                </div>
              ` : ''}
            </div>
            
            <div class="contract-card__actions">
              <a href="contract_detail.html?id=${id}" class="button">Ver Detalle</a>
              ${saldo.saldo > 0 ? `
                <button class="button button--outline" onclick="showPaymentModal(${id}, ${saldo.saldo})">
                  Registrar Pago
                </button>
              ` : ''}
            </div>
          </article>
        `;
      }).join('');
    }
    
    function checkVencimientos() {
      const vencidos = allContracts.filter(c => {
        const fechaPlazo = c.fechaPlazo || c.con_fecha_plazo;
        if (!fechaPlazo) return false;
        return new Date(fechaPlazo) < new Date() && c.estado !== 'P';
      });
      
      if (vencidos.length > 0) {
        const alertContainer = document.getElementById('alertsContainer');
        if (alertContainer) {
          alertContainer.innerHTML = `
            <div class="alert-banner" style="background: linear-gradient(135deg, #FEE2E2, #FECACA); border-color: var(--color-error);">
              <div class="alert-banner__icon">üö®</div>
              <div class="alert-banner__content">
                <h4 class="alert-banner__title" style="color: #991B1B;">Contratos vencidos</h4>
                <p class="alert-banner__text" style="color: #7F1D1D;">Tienes ${vencidos.length} contrato${vencidos.length > 1 ? 's' : ''} vencido${vencidos.length > 1 ? 's' : ''}. Contacta a la sucursal para regularizar tu situaci√≥n.</p>
              </div>
            </div>
          `;
          alertContainer.style.display = 'block';
        }
      }
    }
    
    window.showPaymentModal = function(contratoId, saldo) {
      const modal = document.getElementById('paymentModal');
      const form = document.getElementById('paymentModalForm');
      const saldoDisplay = document.getElementById('paymentModalSaldo');
      const montoInput = document.getElementById('paymentModalMonto');
      
      if (!modal || !form) {
        // Si el modal no existe, crearlo
        createPaymentModal();
        showPaymentModal(contratoId, saldo);
        return;
      }
      
      // Actualizar datos del modal
      saldoDisplay.textContent = formatCurrency(saldo);
      montoInput.max = saldo;
      montoInput.value = '';
      form.dataset.contratoId = contratoId;
      form.dataset.saldo = saldo;
      
      // Resetear formulario
      form.reset();
      document.getElementById('paymentModalMethod').value = 'Efectivo';
      
      // Mostrar modal
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Focus en el input de monto
      setTimeout(() => montoInput.focus(), 100);
    };
    
    function createPaymentModal() {
      const modalHTML = `
        <div id="paymentModal" class="payment-modal" style="display:none;">
          <div class="payment-modal__backdrop" onclick="closePaymentModal()"></div>
          <div class="payment-modal__content">
            <div class="payment-modal__header">
              <h2 style="margin:0;display:flex;align-items:center;gap:var(--spacing-2);">
                üí≥ Registrar Pago
              </h2>
              <button class="payment-modal__close" onclick="closePaymentModal()" aria-label="Cerrar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            <div class="payment-modal__body">
              <div class="payment-modal__saldo-info">
                <span class="payment-modal__saldo-label">Saldo pendiente:</span>
                <span class="payment-modal__saldo-amount" id="paymentModalSaldo">$0</span>
              </div>
              <form id="paymentModalForm">
                <div class="form-group">
                  <label for="paymentModalMonto">Monto del pago *</label>
                  <input 
                    type="number" 
                    id="paymentModalMonto" 
                    class="input" 
                    min="0.01" 
                    step="0.01" 
                    required
                    placeholder="0.00"
                  >
                  <small style="color:var(--color-text-muted);font-size:var(--font-size-xs);margin-top:var(--spacing-1);display:block;">
                    Ingresa el monto que deseas pagar
                  </small>
                </div>
                
                <div class="form-group">
                  <label for="paymentModalMethod">M√©todo de pago *</label>
                  <select id="paymentModalMethod" class="input" required>
                    <option value="Efectivo">üíµ Efectivo</option>
                    <option value="Transferencia">üè¶ Transferencia bancaria</option>
                    <option value="Tarjeta">üí≥ Tarjeta d√©bito/cr√©dito</option>
                    <option value="Cheque">üìù Cheque</option>
                    <option value="Otro">üìå Otro</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="paymentModalReference">Referencia / Comprobante</label>
                  <input 
                    type="text" 
                    id="paymentModalReference" 
                    class="input" 
                    placeholder="N√∫mero de comprobante, transferencia, etc."
                  >
                  <small style="color:var(--color-text-muted);font-size:var(--font-size-xs);margin-top:var(--spacing-1);display:block;">
                    Opcional: n√∫mero de referencia del pago
                  </small>
                </div>
                
                <div class="form-group">
                  <label for="paymentModalObservations">Observaciones</label>
                  <textarea 
                    id="paymentModalObservations" 
                    class="input" 
                    rows="3" 
                    placeholder="Notas adicionales sobre el pago (opcional)"
                  ></textarea>
                </div>
                
                <div class="payment-modal__actions">
                  <button type="button" class="button button--outline" onclick="closePaymentModal()">
                    Cancelar
                  </button>
                  <button type="submit" class="button payment-modal__submit-btn">
                    <span style="display:inline-flex;align-items:center;gap:var(--spacing-2);">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Registrar Pago
                    </span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      setupPaymentModalForm();
    }
    
    function setupPaymentModalForm() {
      const form = document.getElementById('paymentModalForm');
      const montoInput = document.getElementById('paymentModalMonto');
      const saldoDisplay = document.getElementById('paymentModalSaldo');
      
      if (!form) return;
      
      // Validar monto en tiempo real
      montoInput.addEventListener('input', function() {
        const monto = Number(this.value);
        const saldo = Number(form.dataset.saldo || 0);
        
        if (monto > saldo) {
          this.setCustomValidity(`El monto no puede ser mayor al saldo pendiente (${formatCurrency(saldo)})`);
          this.style.borderColor = 'var(--color-error)';
        } else if (monto <= 0) {
          this.setCustomValidity('El monto debe ser mayor a 0');
          this.style.borderColor = 'var(--color-error)';
        } else {
          this.setCustomValidity('');
          this.style.borderColor = '';
        }
      });
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const contratoId = form.dataset.contratoId;
        const monto = Number(montoInput.value);
        const metodo = document.getElementById('paymentModalMethod').value;
        const referencia = document.getElementById('paymentModalReference').value.trim();
        const observaciones = document.getElementById('paymentModalObservations').value.trim();
        const saldo = Number(form.dataset.saldo || 0);
        
        if (monto <= 0 || monto > saldo) {
          showToast('Monto inv√°lido');
          return;
        }
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:var(--spacing-2);">‚è≥ Registrando...</span>';
        
        try {
          await registrarPago(contratoId, monto, metodo, referencia, observaciones);
          closePaymentModal();
          showToast('Pago registrado exitosamente');
          await loadContracts();
        } catch (err) {
          console.error('Error registrando pago:', err);
          showToast('No se pudo registrar el pago: ' + (err.message || 'Error desconocido'));
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
    }
    
    window.closePaymentModal = function() {
      const modal = document.getElementById('paymentModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    };
    
    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closePaymentModal();
      }
    });
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0
      }).format(amount || 0);
    }
    
    async function registrarPago(contratoId, monto, metodo, referencia, observaciones) {
      await apiFetch('contratos', '/pagos', {
        method: 'POST',
        body: {
          contrato_id: contratoId,
          monto,
          metodo_pago: metodo,
          referencia: referencia || null,
          observaciones: observaciones || null
        }
      });
    }
    
    function getEstadoBadge(estado) {
      const map = {
        'A': { text: 'Activo', class: 'badge--success' },
        'V': { text: 'Vencido', class: 'badge--error' },
        'C': { text: 'Cancelado', class: 'badge--secondary' },
        'R': { text: 'Renovado', class: 'badge--info' },
        'P': { text: 'Pagado', class: 'badge--success' }
      };
      const info = map[estado] || { text: estado, class: 'badge--secondary' };
      return `<span class="badge ${info.class}">${info.text}</span>`;
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '‚Äî';
      try {
        return new Date(dateStr).toLocaleDateString('es-ES', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch {
        return dateStr;
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
  </script>
</head>
<body>
  <header></header>
  <main class="container">
    <div class="page-header">
      <h1 class="page-title">Mis Contratos</h1>
      <p class="text-muted">Consulta el estado de tus pr√©stamos y realiza pagos</p>
    </div>
    
    <div id="alertsContainer" style="display:none;"></div>
    
    <div id="loadingState" class="empty-state" style="display: none;">
      <div class="spinner" style="margin: 0 auto;"></div>
      <p class="empty-state-text">Cargando contratos...</p>
    </div>
    
    <div id="emptyState" class="empty-state" style="display: none;">
      <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 7L12 3L4 7M20 7L12 11M20 7V17L12 21M12 11L4 7M12 11V21M4 7V17L12 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h3 class="empty-state-title">No tienes contratos a√∫n</h3>
      <p class="empty-state-text">Las solicitudes aprobadas aparecer√°n aqu√≠ como contratos.</p>
    </div>
    
    <section id="contractsContainer" style="display:none;"></section>
  </main>
</body>
</html>

    window.addEventListener('DOMContentLoaded', async ()=>{
      renderHeader();
      const tbody = document.querySelector('tbody');
      const qInput = document.getElementById('q');
      const pageSizeSel = document.getElementById('pageSize');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const pageInfo = document.getElementById('pageInfo');

      let all = [];
      let filtered = [];
      let page = 1;

      function normalize(c){
        return {
          id: c.id,
          estado: c.estado ?? c.con_estado ?? '‚Äî',
          fecha: c.fecha ?? c.con_fecha ?? null,
          cliente: c.cliente ?? c.con_cliente ?? c.clienteNombre ?? null,
          fechaPlazo: c.fechaPlazo ?? c.con_fecha_plazo ?? c.fecha_plazo ?? null
        };
      }

      function render(){
        const pageSize = Number(pageSizeSel.value);
        const start = (page-1)*pageSize;
        const rows = filtered.slice(start, start+pageSize);
        tbody.innerHTML = rows.map(c=>`<tr><td>#${c.id}</td><td>${c.cliente ?? '‚Äî'}</td><td>${c.estado}</td><td>${c.fecha ? new Date(c.fecha).toLocaleString() : '‚Äî'}</td><td>${c.fechaPlazo ? new Date(c.fechaPlazo).toLocaleDateString() : '‚Äî'}</td><td><a class=\"button\" href=\"contract_detail.html?id=${c.id}\">Ver</a></td></tr>`).join('');
        const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
        pageInfo.textContent = `${page} / ${totalPages}`;
        prevBtn.disabled = page<=1;
        nextBtn.disabled = page>=totalPages;
      }

      function applyFilter(){
        const q = (qInput.value||'').toLowerCase();
        filtered = all.filter(c => `${c.id} ${c.estado} ${c.fecha ?? ''} ${c.cliente ?? ''} ${c.fechaPlazo ?? ''}`.toLowerCase().includes(q));
        page = 1;
        render();
      }

      prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
      nextBtn.addEventListener('click', ()=>{ const totalPages=Math.ceil(filtered.length/Number(pageSizeSel.value))||1; if(page<totalPages){ page++; render(); }});
      pageSizeSel.addEventListener('change', ()=>{ page=1; render(); });
      qInput.addEventListener('input', ()=> applyFilter());

      try{
        const list = await apiFetch('contratos','');
        all = (list||[]).map(normalize);
        filtered = all.slice();
        render();
      }catch{ tbody.innerHTML = '<tr><td colspan=4>No se pudieron cargar</td></tr>'; }
    });
  </script>
</head>
<body>
  <header></header>
  <main class="container">
    <h1>Contratos</h1>
    <div class="card" style="margin-bottom:12px;display:flex;gap:12px;align-items:center">
      <input id="q" class="input" placeholder="Buscar por id, estado o fecha" style="flex:1">
      <label for="pageSize" style="color:var(--color-text-muted)">Por p√°gina</label>
      <select id="pageSize" class="input" style="width:120px">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
      </select>
      <button id="prev" class="button" type="button">Anterior</button>
      <span id="pageInfo" style="min-width:60px;text-align:center">1 / 1</span>
      <button id="next" class="button" type="button">Siguiente</button>
    </div>
    <table class="table">
      <thead><tr><th>ID</th><th>Usuario</th><th>Estado</th><th>Fecha</th><th>Plazo</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </main>
</body>
</html>

